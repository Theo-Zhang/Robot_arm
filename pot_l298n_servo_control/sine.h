const PROGMEM int sinetable[256] = {
  512 ,
  516 ,
  521 ,
  525 ,
  530 ,
  534 ,
  539 ,
  543 ,
  548 ,
  552 ,
  556 ,
  561 ,
  565 ,
  569 ,
  574 ,
  578 ,
  582 ,
  586 ,
  591 ,
  595 ,
  599 ,
  603 ,
  607 ,
  610 ,
  614 ,
  618 ,
  622 ,
  625 ,
  629 ,
  632 ,
  636 ,
  639 ,
  642 ,
  645 ,
  648 ,
  651 ,
  654 ,
  657 ,
  660 ,
  663 ,
  665 ,
  668 ,
  670 ,
  672 ,
  674 ,
  677 ,
  679 ,
  680 ,
  682 ,
  684 ,
  685 ,
  687 ,
  688 ,
  690 ,
  691 ,
  692 ,
  693 ,
  694 ,
  694 ,
  695 ,
  695 ,
  696 ,
  696 ,
  696 ,
  696 ,
  696 ,
  696 ,
  696 ,
  695 ,
  695 ,
  694 ,
  694 ,
  693 ,
  692 ,
  691 ,
  690 ,
  688 ,
  687 ,
  685 ,
  684 ,
  682 ,
  680 ,
  679 ,
  677 ,
  674 ,
  672 ,
  670 ,
  668 ,
  665 ,
  663 ,
  660 ,
  657 ,
  654 ,
  651 ,
  648 ,
  645 ,
  642 ,
  639 ,
  636 ,
  632 ,
  629 ,
  625 ,
  622 ,
  618 ,
  614 ,
  610 ,
  607 ,
  603 ,
  599 ,
  595 ,
  591 ,
  586 ,
  582 ,
  578 ,
  574 ,
  569 ,
  565 ,
  561 ,
  556 ,
  552 ,
  548 ,
  543 ,
  539 ,
  534 ,
  530 ,
  525 ,
  521 ,
  516 ,
  512 ,
  507 ,
  502 ,
  498 ,
  493 ,
  489 ,
  484 ,
  480 ,
  475 ,
  471 ,
  467 ,
  462 ,
  458 ,
  454 ,
  449 ,
  445 ,
  441 ,
  437 ,
  432 ,
  428 ,
  424 ,
  420 ,
  416 ,
  413 ,
  409 ,
  405 ,
  401 ,
  398 ,
  394 ,
  391 ,
  387 ,
  384 ,
  381 ,
  378 ,
  375 ,
  372 ,
  369 ,
  366 ,
  363 ,
  360 ,
  358 ,
  355 ,
  353 ,
  351 ,
  349 ,
  346 ,
  344 ,
  343 ,
  341 ,
  339 ,
  338 ,
  336 ,
  335 ,
  333 ,
  332 ,
  331 ,
  330 ,
  329 ,
  329 ,
  328 ,
  328 ,
  327 ,
  327 ,
  327 ,
  327 ,
  327 ,
  327 ,
  327 ,
  328 ,
  328 ,
  329 ,
  329 ,
  330 ,
  331 ,
  332 ,
  333 ,
  335 ,
  336 ,
  338 ,
  339 ,
  341 ,
  343 ,
  344 ,
  346 ,
  349 ,
  351 ,
  353 ,
  355 ,
  358 ,
  360 ,
  363 ,
  366 ,
  369 ,
  372 ,
  375 ,
  378 ,
  381 ,
  384 ,
  387 ,
  391 ,
  394 ,
  398 ,
  401 ,
  405 ,
  409 ,
  413 ,
  416 ,
  420 ,
  424 ,
  428 ,
  432 ,
  437 ,
  441 ,
  445 ,
  449 ,
  454 ,
  458 ,
  462 ,
  467 ,
  471 ,
  475 ,
  480 ,
  484 ,
  489 ,
  493 ,
  498 ,
  502 ,
  507 ,
};

//# define nelem 256
//# define nsplit 16

class SineGen {
  public:
    int cntr = 0;

    int bias = 0;
    int scale = 0;

    int nelem = 256;
    int nsplit = 16;

    SineGen(int b, int s) {
      bias = b; scale = s;
    }
    SineGen() {}

    int obtain(int pos) { // pos min 0 max nelem*nsplit
      int index = pos / nsplit;
      int k1 = read(index);
      int k2 = read(index + 1);

      int substep = pos % nsplit;
      int diff = k2 - k1;
      int delta = (diff * substep ) / nsplit;
      int ans = k1 + delta;

      ans = shift(ans, scale) + (512 - shift(512, scale)); // scale while keeping 512 as center
      ans += bias; // add bias

      return clip(ans, 1, 1022); // sanity
    }

    int read(int index) {
      return pgm_read_word(sinetable + (index % nelem));
    }

    int next() {
      cntr = (cntr + 1) % (nelem * nsplit);
      int sine_wave = obtain(cntr);
      return sine_wave;
    }
};
